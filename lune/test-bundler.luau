-- MIT License | Copyright (c) 2023 Latte Softworks <https://latte.to>

local fs = require("@lune/fs")
local roblox = require("@lune/roblox")

local Instance = roblox.Instance

local BundleModel = require("lib/BundleModel")

local StringUtils = require("lib/StringUtils")

local FilePath = "junk/testgen.lua"
local CodegenHeader = "-- Test - @generated by the Wax bundler!\n--!nocheck\n--!nolint\n\n"

if not fs.isDir("junk") then
    fs.writeDir("junk")
end

local Script do
    Script = Instance.new("Script")
    Script.Name = "Script"
    Script.Source = "local task = task or require('@lune/task') task.wait(3) print(require(script.CoolModule))"

    local OtherScript = Instance.new("Script")
    OtherScript.Name = "OtherScript"
    OtherScript.Source = "local task = task or require('@lune/task') task.wait(1) error('intentional error')"
    OtherScript.Parent = Script

    local WillFailToCompile = Instance.new("Script")
    WillFailToCompile.Name = "WillFailToCompile"
    WillFailToCompile.Source = "a"
    WillFailToCompile.Parent = Script

    local CoolModule = Instance.new("ModuleScript")
    CoolModule.Name = "CoolModule"
    CoolModule.Source = "return 'hi mom'"
    CoolModule.Parent = Script
end

local ModelCodegen = BundleModel({Script}, nil, false, StringUtils.LineCount(CodegenHeader) - 1)
fs.writeFile(FilePath, ModelCodegen)
--Run("darklua", {"process", FilePath, FilePath})
fs.writeFile(FilePath, CodegenHeader .. fs.readFile(FilePath))
